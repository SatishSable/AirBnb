<% layout("layouts/boilerplate")%>

  <style>
    /* Additional page-specific styles */
    .hero-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 3rem 0;
      margin: -2rem -2rem 2rem -2rem;
      text-align: center;
      border-radius: 0 0 24px 24px;
    }

    .hero-section h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }

    .hero-section p {
      font-size: 1.25rem;
      opacity: 0.9;
    }

    .search-section {
      max-width: 800px;
      margin: -2rem auto 2rem;
      background: white;
      padding: 1.5rem;
      border-radius: 16px;
      box-shadow: 0 8px 28px rgba(0, 0, 0, 0.15);
      animation: slideUp 0.6s ease-out;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .search-section:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes pulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }
    }

    .search-inputs {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr auto;
      gap: 1rem;
      align-items: end;
    }

    .search-input-group {
      display: flex;
      flex-direction: column;
      animation: fadeIn 0.5s ease-out;
    }

    .search-input-group:nth-child(1) {
      animation-delay: 0.1s;
    }

    .search-input-group:nth-child(2) {
      animation-delay: 0.2s;
    }

    .search-input-group:nth-child(3) {
      animation-delay: 0.3s;
    }

    .search-input-group label {
      font-size: 0.75rem;
      font-weight: 600;
      color: #222;
      margin-bottom: 0.25rem;
      transition: color 0.3s ease;
    }

    .search-input-group:hover label {
      color: #FF385C;
    }

    .search-input-group input {
      padding: 0.75rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 0.875rem;
      transition: all 0.3s ease;
    }

    .search-input-group input:focus {
      border-color: #FF385C;
      box-shadow: 0 0 0 3px rgba(255, 56, 92, 0.15);
      outline: none;
      transform: scale(1.02);
    }

    .search-input-group input:hover {
      border-color: #FF385C;
    }

    .search-input-group input[type="number"] {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    .search-input-group input[type="number"]::-webkit-outer-spin-button,
    .search-input-group input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      appearance: none;
      margin: 0;
    }

    .search-btn {
      background: linear-gradient(135deg, #FF385C, #FF5A5F, #E91E63);
      background-size: 200% 200%;
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      animation: fadeIn 0.5s ease-out 0.4s backwards;
    }

    .search-btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 25px rgba(255, 56, 92, 0.4);
      animation: pulse 1s ease infinite;
    }

    .search-btn:active {
      transform: translateY(0) scale(0.98);
    }

    .search-btn i {
      margin-right: 0.5rem;
      transition: transform 0.3s ease;
    }

    .search-btn:hover i {
      transform: rotate(15deg);
    }

    .listings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .listings-count {
      font-size: 1.25rem;
      font-weight: 600;
      color: #222;
    }

    .sort-options {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .sort-options select {
      padding: 0.5rem 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.875rem;
    }

    @media (max-width: 768px) {
      .search-inputs {
        grid-template-columns: 1fr;
      }

      .hero-section h1 {
        font-size: 1.75rem;
      }
    }
  </style>

  <!-- Hero Section -->
  <div class="hero-section">
    <h1>Find the Perfect Home</h1>
    <p>Rent from local hosts and discover unique stays for your dream vacation.</p>
  </div>

  <!-- Search Section -->
  <div class="search-section">
    <form action="/listings/search" method="GET">
      <div class="search-inputs">
        <div class="search-input-group">
          <label for="location">Location</label>
          <input type="text" id="location" name="location" placeholder="Where are you going?" class="form-control">
        </div>

        <div class="search-input-group">
          <label for="checkIn">Check in</label>
          <input type="date" id="checkIn" name="checkIn" class="form-control">
        </div>

        <div class="search-input-group">
          <label for="guests">Guests</label>
          <input type="number" id="guests" name="guests" min="1" max="20" placeholder="Number of guests"
            class="form-control">
        </div>

        <button type="submit" class="search-btn">
          <i class="fas fa-search"></i> Search
        </button>
      </div>
    </form>
  </div>



  <!-- Listings Header -->
  <div class="listings-header">
    <div class="listings-count">
      <span id="listingsCount">
        <%= allListings.length %>
      </span> Properties Found
    </div>
    <div class="sort-options">
      <label for="sortBy">Sort by:</label>
      <select id="sortBy" class="form-select">
        <option value="recommended">Recommended</option>
        <option value="priceLow">Price: Low to High</option>
        <option value="priceHigh">Price: High to Low</option>
        <option value="rating">Highest Rated</option>
      </select>
    </div>
  </div>

  <!-- Listings Grid -->
  <div class="row row-cols-lg-3 row-cols-md-2 row-cols-sm-1 row-cols-1 mt-3 px-0" id="listingsGrid">
    <% for(let listing of allListings) { %>
      <a href="/listings/<%= listing._id%>" class="listing-link" style="text-decoration: none; color: inherit;">
        <div class="card col listing-card" style="width: 100%; max-width: 20rem;"
          data-category="<%= listing.category || 'Trending' %>">
          <!-- Wishlist Button -->
          <button class="wishlist-btn" onclick="event.preventDefault(); toggleWishlist('<%= listing._id %>')">
            <i class="far fa-heart"></i>
          </button>

          <img
            src="<%= listing.image && listing.image.url ? listing.image.url : 'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=500' %>"
            class="card-img-top" alt="<%= listing.title %>" style="height: 280px;">

          <div class="card-img-overlay"></div>

          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h5 class="mb-0">
                <%= listing.title %>
              </h5>
              <% if(listing.reviews && listing.reviews.length> 0) { %>
                <span class="rating-badge">
                  <i class="fas fa-star"></i>
                  <span>4.8</span>
                </span>
                <% } %>
            </div>

            <p class="card-text text-muted mb-1">
              <%= listing.location %>, <%= listing.country %>
            </p>

            <% if(listing.guests || listing.bedrooms || listing.beds) { %>
              <p class="card-text text-muted small mb-2">
                <% if(listing.guests) { %>
                  <%= listing.guests %> guests · <% } %>
                      <% if(listing.bedrooms) { %>
                        <%= listing.bedrooms %> bedrooms · <% } %>
                            <% if(listing.beds) { %>
                              <%= listing.beds %> beds<% } %>
              </p>
              <% } %>

                <p class="card-text">
                  <span class="price">₹<%= listing.price.toLocaleString("en-IN") %></span> / night
                  <i class="tax-info">&nbsp; &nbsp;+ 18% GST</i>
                </p>
          </div>
        </div>
      </a>
      <% } %>
  </div>

  <script>
    // Tax Toggle
    let taxToggle = document.getElementById('switchCheckDefault');
    taxToggle.addEventListener('click', function () {
      let taxInfo = document.getElementsByClassName('tax-info');
      for (info of taxInfo) {
        if (taxToggle.checked) {
          info.style.display = 'inline';
        } else {
          info.style.display = 'none';
        }
      }
    });

    const listingCards = document.querySelectorAll('.listing-card');

    // Sort Functionality
    const sortSelect = document.getElementById('sortBy');
    const listingsGrid = document.getElementById('listingsGrid');

    sortSelect.addEventListener('change', function () {
      const sortBy = this.value;
      const listings = Array.from(listingCards).map(card => card.parentElement);

      listings.sort((a, b) => {
        const priceA = parseInt(a.querySelector('.price').textContent.replace(/[₹,]/g, ''));
        const priceB = parseInt(b.querySelector('.price').textContent.replace(/[₹,]/g, ''));

        switch (sortBy) {
          case 'priceLow':
            return priceA - priceB;
          case 'priceHigh':
            return priceB - priceA;
          case 'rating':
            // For now, just shuffle
            return Math.random() - 0.5;
          default:
            return 0;
        }
      });

      // Re-append sorted listings
      listings.forEach(listing => {
        listingsGrid.appendChild(listing);
      });
    });

    // Wishlist Functionality
    function toggleWishlist(listingId) {
      const btn = event.currentTarget;
      const icon = btn.querySelector('i');

      if (icon.classList.contains('far')) {
        icon.classList.remove('far');
        icon.classList.add('fas');
        btn.classList.add('active');

        // Save to localStorage
        let wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
        if (!wishlist.includes(listingId)) {
          wishlist.push(listingId);
          localStorage.setItem('wishlist', JSON.stringify(wishlist));
        }
      } else {
        icon.classList.remove('fas');
        icon.classList.add('far');
        btn.classList.remove('active');

        // Remove from localStorage
        let wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
        wishlist = wishlist.filter(id => id !== listingId);
        localStorage.setItem('wishlist', JSON.stringify(wishlist));
      }
    }

    // Load wishlist on page load
    document.addEventListener('DOMContentLoaded', function () {
      const wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');

      wishlist.forEach(listingId => {
        const card = document.querySelector(`[data-category] a[href="/listings/${listingId}"]`);
        if (card) {
          const btn = card.querySelector('.wishlist-btn');
          const icon = btn.querySelector('i');
          icon.classList.remove('far');
          icon.classList.add('fas');
          btn.classList.add('active');
        }
      });
    });

    // Add fade-in animation to cards
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('fade-in');
        }
      });
    });

    listingCards.forEach(card => {
      observer.observe(card);
    });
  </script>